From f3dc6f0d92a15b8268e961b4b0522a0cb132a6ce Mon Sep 17 00:00:00 2001
From: Steven van der Schoot <steven.vanderschoot@solarteameindhoven.nl>
Date: Fri, 29 Sep 2017 15:51:50 +0200
Subject: [PATCH 2/2] Add option for 512M cma limit

---
 .../arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts | 36 ++++++++++------
 arch/arm/boot/dts/overlays/vc4-kms-v3d-overlay.dts | 50 +++++++++++++---------
 2 files changed, 51 insertions(+), 35 deletions(-)

diff --git a/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
index 36fbf6c..8382696 100644
--- a/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
+++ b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
@@ -11,53 +11,60 @@
 	fragment@0 {
 		target-path = "/chosen";
 		__overlay__ {
-			bootargs = "cma=256M";
+			bootargs = "cma=512M";
 		};
 	};
 
 	fragment@1 {
 		target-path = "/chosen";
+		__overlay__ {
+			bootargs = "cma=256M";
+		};
+	};
+
+	fragment@2 {
+		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=192M";
 		};
 	};
 
-	fragment@2 {
+	fragment@3 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=128M";
 		};
 	};
 
-	fragment@3 {
+	fragment@4 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=96M";
 		};
 	};
 
-	fragment@4 {
+	fragment@5 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=64M";
 		};
 	};
 
-	fragment@5 {
+	fragment@6 {
 		target = <&fb>;
 		__overlay__  {
 			status = "disabled";
 		};
 	};
 
-	fragment@6 {
+	fragment@7 {
 		target = <&firmwarekms>;
 		__overlay__  {
 			status = "okay";
 		};
 	};
 
-	fragment@7 {
+	fragment@8 {
 		target = <&v3d>;
 		__overlay__  {
 			interrupts = <1 10>;
@@ -65,14 +72,14 @@
 		};
 	};
 
-	fragment@8 {
+	fragment@9 {
 		target = <&gpu>;
 		__overlay__  {
 			status = "okay";
 		};
 	};
 
-	fragment@9 {
+	fragment@10 {
 		target-path = "/soc/dma";
 		__overlay__ {
 			brcm,dma-channel-mask = <0x7f35>;
@@ -80,10 +87,11 @@
 	};
 
 	__overrides__ {
-		cma-256 = <0>,"+0-1-2-3-4";
-		cma-192 = <0>,"-0+1-2-3-4";
-		cma-128 = <0>,"-0-1+2-3-4";
-		cma-96  = <0>,"-0-1-2+3-4";
-		cma-64  = <0>,"-0-1-2-3+4";
+		cma-512 = <0>,"+0-1-2-3-4-5";
+		cma-256 = <0>,"-0-1-2-3-4-5";
+		cma-192 = <0>,"-0-1-2-3-4-5";
+		cma-128 = <0>,"-0-1-2-3-4-5";
+		cma-96  = <0>,"-0-1-2-3-4-5";
+		cma-64  = <0>,"-0-1-2-3-4+5";
 	};
 };
diff --git a/arch/arm/boot/dts/overlays/vc4-kms-v3d-overlay.dts b/arch/arm/boot/dts/overlays/vc4-kms-v3d-overlay.dts
index 7d0d659..04aec59 100644
--- a/arch/arm/boot/dts/overlays/vc4-kms-v3d-overlay.dts
+++ b/arch/arm/boot/dts/overlays/vc4-kms-v3d-overlay.dts
@@ -13,60 +13,67 @@
 	fragment@0 {
 		target-path = "/chosen";
 		__overlay__ {
-			bootargs = "cma=256M";
+			bootargs = "cma=512M";
 		};
 	};
 
 	fragment@1 {
 		target-path = "/chosen";
+		__overlay__ {
+			bootargs = "cma=256M";
+		};
+	};
+
+	fragment@2 {
+		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=192M";
 		};
 	};
 
-	fragment@2 {
+	fragment@3 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=128M";
 		};
 	};
 
-	fragment@3 {
+	fragment@4 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=96M";
 		};
 	};
 
-	fragment@4 {
+	fragment@5 {
 		target-path = "/chosen";
 		__dormant__ {
 			bootargs = "cma=64M";
 		};
 	};
 
-	fragment@5 {
+	fragment@6 {
 		target = <&i2c2>;
 		__overlay__  {
 			status = "okay";
 		};
 	};
 
-	fragment@6 {
+	fragment@7 {
 		target = <&cprman>;
 		__overlay__  {
 			status = "okay";
 		};
 	};
 
-	fragment@7 {
+	fragment@8 {
 		target = <&fb>;
 		__overlay__  {
 			status = "disabled";
 		};
 	};
 
-	fragment@8 {
+	fragment@9 {
 		target = <&pixelvalve0>;
 		__overlay__  {
 			interrupts = <2 13>; /* pwa0 */
@@ -74,7 +81,7 @@
 		};
 	};
 
-	fragment@9 {
+	fragment@10 {
 		target = <&pixelvalve1>;
 		__overlay__  {
 			interrupts = <2 14>; /* pwa1 */
@@ -82,7 +89,7 @@
 		};
 	};
 
-	fragment@10 {
+	fragment@11 {
 		target = <&pixelvalve2>;
 		__overlay__  {
 			interrupts = <2 10>; /* pixelvalve */
@@ -90,7 +97,7 @@
 		};
 	};
 
-	fragment@11 {
+	fragment@12 {
 		target = <&hvs>;
 		__overlay__  {
 			interrupts = <2 1>;
@@ -98,7 +105,7 @@
 		};
 	};
 
-	fragment@12 {
+	fragment@13 {
 		target = <&hdmi>;
 		__overlay__  {
 			interrupts = <2 8>, <2 9>;
@@ -106,7 +113,7 @@
 		};
 	};
 
-	fragment@13 {
+	fragment@14 {
 		target = <&v3d>;
 		__overlay__  {
 			interrupts = <1 10>;
@@ -114,14 +121,14 @@
 		};
 	};
 
-	fragment@14 {
+	fragment@15 {
 		target = <&gpu>;
 		__overlay__  {
 			status = "okay";
 		};
 	};
 
-	fragment@15 {
+	fragment@16 {
 		target-path = "/soc/dma";
 		__overlay__ {
 			brcm,dma-channel-mask = <0x7f35>;
@@ -129,7 +136,7 @@
 	};
 
 
-	fragment@16 {
+	fragment@17 {
 		target = <&clocks>;
 		__overlay__  {
 			claim-clocks = <
@@ -142,10 +149,11 @@
 	};
 
 	__overrides__ {
-		cma-256 = <0>,"+0-1-2-3-4";
-		cma-192 = <0>,"-0+1-2-3-4";
-		cma-128 = <0>,"-0-1+2-3-4";
-		cma-96  = <0>,"-0-1-2+3-4";
-		cma-64  = <0>,"-0-1-2-3+4";
+		cma-512 = <0>,"+0-1-2-3-4-5";
+		cma-256 = <0>,"-0+1-2-3-4-5";
+		cma-192 = <0>,"-0-1+2-3-4-5";
+		cma-128 = <0>,"-0-1-2+3-4-5";
+		cma-96  = <0>,"-0-1-2-3+4-5";
+		cma-64  = <0>,"-0-1-2-3-4+5";
 	};
 };
-- 
2.5.5

